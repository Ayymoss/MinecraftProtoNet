@using MinecraftProtoNet.Packets.Base.Definitions
@using Bot_Web.Services
@inject BotService Bot
@implements IDisposable

<div class="bg-mc-card backdrop-blur-md rounded-xl border border-slate-700/50 p-6 shadow-xl">
    <div class="flex items-center gap-3 mb-6">
        <i class="ph-duotone ph-backpack text-2xl text-emerald-400"></i>
        <h2 class="text-xl font-semibold text-gray-100">Inventory</h2>
    </div>

    @if (!Bot.IsConnected)
    {
        <div class="text-center py-8 text-gray-500">
            <i class="ph-duotone ph-package text-4xl mb-2 block"></i>
            <p>Connect to view inventory</p>
        </div>
    }
    else
    {
        var inventory = Bot.State.LocalPlayer?.Entity?.Inventory;
        var heldSlot = inventory?.HeldSlotWithOffset ?? 36;
        
        <!-- Main Inventory (Slots 9-35: 3 rows of 9) -->
        <div class="mb-6">
            <p class="text-xs text-gray-500 mb-2 uppercase tracking-wide">Main Inventory</p>
            <div class="grid grid-cols-9 gap-1">
                @for (int i = 9; i <= 35; i++)
                {
                    var slotIndex = i;
                    var slot = inventory?.GetSlot((short)slotIndex) ?? Slot.Empty;
                    <div class="@GetSlotClass(slotIndex, heldSlot) group relative cursor-pointer"
                         draggable="true"
                         @ondragstart="() => OnDragStart(slotIndex)"
                         @ondrop="() => OnDrop(slotIndex)"
                         @ondragover:preventDefault
                         title="@GetFullItemName(slot.ItemId)">
                        @if (slot.ItemCount > 0 && slot.ItemId.HasValue)
                        {
                            <span class="text-[10px] leading-tight text-center break-words hyphens-auto">@GetItemName(slot.ItemId.Value)</span>
                            <span class="absolute bottom-0.5 right-1 text-[9px] text-emerald-400 font-bold">@slot.ItemCount</span>
                        }
                    </div>
                }
            </div>
        </div>

        <!-- Hotbar (Slots 36-44) -->
        <div>
            <p class="text-xs text-gray-500 mb-2 uppercase tracking-wide">Hotbar (click to select)</p>
            <div class="grid grid-cols-9 gap-1">
                @for (int i = 36; i <= 44; i++)
                {
                    var slotIndex = i;
                    var slot = inventory?.GetSlot((short)slotIndex) ?? Slot.Empty;
                    var isHeld = slotIndex == heldSlot;
                    <div class="@GetSlotClass(slotIndex, heldSlot, isHeld) group relative cursor-pointer"
                         @onclick="() => SelectHotbarSlot(slotIndex - 36)"
                         draggable="true"
                         @ondragstart="() => OnDragStart(slotIndex)"
                         @ondrop="() => OnDrop(slotIndex)"
                         @ondragover:preventDefault
                         title="@GetFullItemName(slot.ItemId)">
                        @if (slot.ItemCount > 0 && slot.ItemId.HasValue)
                        {
                            <span class="text-[10px] leading-tight text-center break-words hyphens-auto">@GetItemName(slot.ItemId.Value)</span>
                            <span class="absolute bottom-0.5 right-1 text-[9px] text-emerald-400 font-bold">@slot.ItemCount</span>
                        }
                        @if (isHeld)
                        {
                            <div class="absolute -top-1 -right-1 w-2 h-2 bg-emerald-400 rounded-full animate-pulse"></div>
                        }
                        <span class="absolute top-0.5 left-1 text-[8px] text-gray-600">@(slotIndex - 35)</span>
                    </div>
                }
            </div>
        </div>
    }
</div>

@code {
    private int? _dragSourceSlot;

    protected override void OnInitialized()
    {
        Bot.OnStateChanged += HandleStateChanged;
    }

    private void HandleStateChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private string GetSlotClass(int slotIndex, int heldSlot, bool isHeld = false)
    {
        var baseClass = "w-full aspect-square rounded-md flex flex-col items-center justify-center p-0.5 transition-all duration-150 overflow-hidden min-h-[48px] ";
        
        if (isHeld)
            return baseClass + "bg-emerald-900/50 border-2 border-emerald-400 hover:bg-emerald-800/50";
        
        return baseClass + "bg-slate-800/80 border border-slate-600/50 hover:border-slate-500 hover:bg-slate-700/80";
    }

    private string GetItemName(int itemId)
    {
        var name = Bot.ItemRegistry.GetItemName(itemId);
        if (string.IsNullOrEmpty(name)) return $"#{itemId}";
        
        // Strip "minecraft:" prefix and format nicely
        return name.Replace("minecraft:", "").Replace("_", " ");
    }
    
    private string GetFullItemName(int? itemId)
    {
        if (!itemId.HasValue) return "Empty";
        var name = Bot.ItemRegistry.GetItemName(itemId.Value);
        return string.IsNullOrEmpty(name) ? $"Item #{itemId}" : name.Replace("minecraft:", "").Replace("_", " ");
    }

    private async Task SelectHotbarSlot(int hotbarSlot)
    {
        await Bot.InventoryManager.SetHotbarSlot(hotbarSlot);
        Bot.NotifyStateChanged();
    }

    private void OnDragStart(int slotIndex)
    {
        _dragSourceSlot = slotIndex;
    }

    private async Task OnDrop(int targetSlot)
    {
        if (_dragSourceSlot.HasValue && _dragSourceSlot.Value != targetSlot)
        {
            await Bot.InventoryManager.SwapItems(_dragSourceSlot.Value, targetSlot);
            Bot.NotifyStateChanged();
        }
        _dragSourceSlot = null;
    }

    public void Dispose()
    {
        Bot.OnStateChanged -= HandleStateChanged;
    }
}
